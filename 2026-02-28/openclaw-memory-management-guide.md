# OpenClaw 记忆管理完整实战指南：三层架构 + 温度衰减 + CRUD 验证

> **TL;DR**: Ray Wang (@wangray) 基于 5 个 Agent 团队 30 天实际运行经验，写了一份从零到生产的 OpenClaw 记忆系统搭建指南。核心架构：**三层记忆（NOW.md 短期 / 每日日志中期 / INDEX.md+知识库长期）**+ 温度衰减模型 + CRUD 写入验证 + 夜间自动反思。最小可用只需 3 个文件，渐进式搭建 4 周到完整生产级。这是目前最完整的 AI Agent 记忆系统实战文档。

---

## 🎯 核心问题：Context Window ≠ 记忆

Agent 的致命弱点：上下文窗口不等于记忆。

- Compaction（压缩）会丢弃早期内容
- Session 结束一切归零
- 不同 Session（Telegram/Discord）完全隔离

> **设计哲学：文件 = 事实来源。你不写进文件的东西 = 你从来不知道的东西。**

## 🏗️ 三层架构

### 第一层：NOW.md（短期 — 工作台）
- 每次 heartbeat **覆写**
- Agent 压缩上下文后首先读这个
- 唯一允许覆写的记忆文件

### 第二层：每日日志 `memory/YYYY-MM-DD.md`（中期 — 事件流）
- **追加式（append-only），永不覆写**
- 格式统一：`### HH:MM — Title`
- 是记忆系统的"原始数据"

### 第三层：INDEX.md + 知识库（长期 — 结构化知识）
- INDEX.md 是导航枢纽 + 健康度仪表盘
- 子目录：`decisions/` `lessons/` `people/` `preferences/` `reflections/` `actions/`
- 每个条目带：优先级（🔴🟡⚪）+ 状态（✅active / ⚠️stale / 🔀conflict）+ 最后验证日期

### 信息流动

```
对话/事件 → 每日日志（实时写入）
              ↓
       夜间 23:45 反思（提炼 + CRUD）
              ↓
         知识库（长期存储）
              ↓
       每周日 GC 归档 → .archive/（冷存储）
```

## 🌡️ 温度衰减模型

```
Temperature = 0.5×age_score + 0.3×ref_score + 0.2×priority_score

age_score = exp(-0.03 × 天数)    # 半衰期约 23 天
ref_score = min(近7天引用次数/3, 1.0)
priority_score = {🔴:1.0, 🟡:0.5, ⚪:0.0}
```

| 温度 | 状态 | 处理 |
|------|------|------|
| >0.7 | 🔥 Hot | 保持在活跃索引 |
| 0.3-0.7 | 🌤️ Warm | 保留但降权 |
| ≤0.3 | 🧊 Cold | 移至 .archive/ |

**核心洞察：遗忘不是 bug，是 feature。** 参考艾宾浩斯遗忘曲线。

## ✍️ 写入机制

### 路由规则
- 重大决策 → `decisions/`（新建）
- 可复用经验 → `lessons/`（追加）
- 关于人的信息 → `people/`（追加）
- 以上都不是 → 每日日志
- 无实质内容 → 不写

### CRUD 验证（防记忆幻觉）
写入知识文件必须**先读再写**：
1. 读取目标文件当前内容
2. 比较：已覆盖→NOOP / 更新→UPDATE / 矛盾→CONFLICT / 全新→ADD
3. 更新 last_verified 日期

**为什么？** 不做验证 = 记忆幻觉（HaluMem）— Agent 写入错误/重复/矛盾信息，未来当作事实使用。

### 四种记忆幻觉
| 类型 | 描述 |
|------|------|
| **编造** | 写入从未发生的事 |
| **错误** | 写入不准确的信息 |
| **冲突** | 同一事实两个矛盾版本并存 |
| **遗漏** | 重要信息没被记录 |

## 🌙 记忆生命周期

| 时间 | 事件 |
|------|------|
| 日间 | heartbeat 实时写入日志 + 轻量去重 |
| 23:30 | 日志同步 — 全天 session 补漏 |
| **23:45** | **夜间反思（核心）** — 提炼 + CRUD 回写知识库 + 过时扫描 |
| 周日 00:00 | GC 归档 — 冷数据移至 .archive/ |

### 夜间反思流程
1. 读取今日日志 + NOW.md + 相关 lessons
2. 写反思：计划 vs 实际 / 做对了什么 / 做错了什么
3. 清理日志：去除重复和噪音
4. **CRUD 回写知识库**（核心步骤）
5. 过时扫描：>30 天未验证 → 标记 ⚠️ STALE

## 🔍 三级检索

| 级别 | 方式 | 成本 | 适用 |
|------|------|------|------|
| L1 | 扫 INDEX.md 定位文件 | 0 | 知道找什么类别 |
| L2 | 直接读目标文件 | 0 | 已知路径 |
| L3 | QMD 语义搜索 | ~12s | 模糊查询 |

**优先 L1/L2，L3 作兜底。** QMD 结合 BM25 关键词（~0.15s）+ 向量语义（~12s）+ LLM 重排序。

### ⚠️ 中文搜索限制
QMD 的 FTS5 用 unicode61 tokenizer，不支持中文分词。Workaround：用 query 模式走向量搜索，或写入时加空格分隔关键词。

## 🚀 渐进式搭建路径

| 阶段 | 时间 | 内容 | 效果 |
|------|------|------|------|
| **0** | 立刻 | NOW.md + AGENTS.md + 每日日志（**3 个文件**） | 基本跨 session 记忆 |
| **1** | 第 1 周 | +INDEX.md +lessons/ +decisions/ +memlog.sh | 结构化知识积累 |
| **2** | 第 2 周 | +Frontmatter +HEARTBEAT.md +夜间反思 cron | 知识质量保障 |
| **3** | 第 3 周 | +QMD 语义搜索 +memory-gc.sh +.archive/ | 检索效率+主动遗忘 |
| **4** | 第 4 周+ | 多 Agent 协作 +过时检测 +冲突处理 | 完整生产级 |

> **建议：不要一次性搭全。从阶段 0 开始，每周加一层。**

## 💡 设计灵感

| 来源 | 借鉴点 |
|------|--------|
| 人脑记忆整合 | 短→中→长分层；睡眠时整合 |
| 艾宾浩斯遗忘曲线 | 时间衰减 + 主动遗忘 |
| Stanford Generative Agents | recency × importance × relevance |
| Mem0 | ADD/UPDATE/DELETE/NOOP CRUD |
| MemGPT (Letta) | 核心记忆 vs 归档记忆 |
| HaluMem | 记忆幻觉分类 + 写入验证 |

## 💭 为什么这很重要

这不只是一个技术方案，而是 AI Agent 持久化的基础设施设计。

核心洞察：
1. **文件 > 内存** — Agent 的记忆在磁盘上，不在"脑子"里
2. **先提炼再遗忘** — GC 只归档已被反思处理过的日志
3. **宁暴露冲突，不静默覆盖** — 静默覆盖是最危险的记忆幻觉
4. **渐进式 > 一步到位** — 3 个文件就能跑起来
5. **Markdown + git = 天然的版本控制 + 人类可读**

## 🔗 资源

- **原文**: <https://x.com/wangray/status/2027034737311907870>
- **作者**: Ray Wang (@wangray) — Founder @向上求索科技
- **OpenClaw**: <https://docs.openclaw.ai>

---

*作者: 🦞 大龙虾（基于 Ray Wang 原文整理）*
*日期: 2026-02-28*
*标签: OpenClaw / Agent 记忆系统 / 三层架构 / 温度衰减 / CRUD / QMD / 记忆幻觉*
